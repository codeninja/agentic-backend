name: Auto-move issues to AI Review on PR

on:
  pull_request:
    types: [opened]

jobs:
  move-to-ai-review:
    runs-on: ubuntu-latest
    steps:
      - name: Extract issue number from PR
        id: extract
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          # Check body for "Closes #123" or "closes #123"
          if [[ "$PR_BODY" =~ [Cc]loses[[:space:]]+#([0-9]+) ]]; then
            echo "issue_number=${BASH_REMATCH[1]}" >> "$GITHUB_OUTPUT"
            echo "Found issue #${BASH_REMATCH[1]} from PR body"
            exit 0
          fi
          # Check title for (#123) or (closes #123)
          if [[ "$PR_TITLE" =~ \#([0-9]+) ]]; then
            echo "issue_number=${BASH_REMATCH[1]}" >> "$GITHUB_OUTPUT"
            echo "Found issue #${BASH_REMATCH[1]} from PR title"
            exit 0
          fi
          # Fall back to branch name
          if [[ "$PR_BRANCH" =~ (issue[-/]?)([0-9]+) ]]; then
            echo "issue_number=${BASH_REMATCH[2]}" >> "$GITHUB_OUTPUT"
            echo "Found issue #${BASH_REMATCH[2]} from branch: $PR_BRANCH"
            exit 0
          fi
          echo "No issue number found"

      - name: Move issue to AI Review on project board
        if: steps.extract.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.extract.outputs.issue_number }}"
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          PROJECT_ID="PVT_kwHNOkLOAT6Qtg"
          FIELD_ID="PVTSSF_lAHNOkLOAT6Qts4Pf31M"
          AI_REVIEW_ID="35df9b65"

          NODE_ID=$(gh api graphql \
            -f query='query($owner:String!,$repo:String!,$num:Int!){repository(owner:$owner,name:$repo){issue(number:$num){id}}}' \
            -F owner="$OWNER" -F repo="$REPO" -F num="$ISSUE_NUM" \
            -q '.data.repository.issue.id' 2>/dev/null)

          if [ -z "$NODE_ID" ] || [ "$NODE_ID" = "null" ]; then
            echo "Issue #$ISSUE_NUM not found, skipping"
            exit 0
          fi

          ITEM_ID=$(gh api graphql \
            -f query='mutation($proj:ID!,$content:ID!){addProjectV2ItemById(input:{projectId:$proj,contentId:$content}){item{id}}}' \
            -F proj="$PROJECT_ID" -F content="$NODE_ID" \
            -q '.data.addProjectV2ItemById.item.id')

          if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" = "null" ]; then
            echo "Failed to add issue to project, skipping"
            exit 0
          fi

          gh api graphql \
            -f query='mutation($proj:ID!,$item:ID!,$field:ID!,$val:String!){updateProjectV2ItemFieldValue(input:{projectId:$proj,itemId:$item,fieldId:$field,value:{singleSelectOptionId:$val}}){projectV2Item{id}}}' \
            -F proj="$PROJECT_ID" -F item="$ITEM_ID" -F field="$FIELD_ID" -F val="$AI_REVIEW_ID" \
            > /dev/null

          echo "âœ… Moved issue #$ISSUE_NUM to AI Review"
