name: Triage Agent

on:
  issues:
    types: [labeled]

jobs:
  analyze:
    if: contains(github.event.label.name, 'triage')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install uv
          uv sync

      - name: Generate repo structure
        run: |
          find libs apps -type f -name "*.py" | head -200 > /tmp/repo_files.txt
          echo "## Repo Structure" > /tmp/context.md
          cat /tmp/repo_files.txt >> /tmp/context.md

      - name: Search codebase for relevant files
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "## Relevant Code Snippets" > /tmp/relevant_code.md
          # Extract keywords from title/body and grep
          keywords=$(echo "$ISSUE_TITLE $ISSUE_BODY" | tr '[:upper:]' '[:lower:]' | grep -oE '[a-z_]{4,}' | sort -u | head -15)
          for kw in $keywords; do
            matches=$(grep -rl --include="*.py" "$kw" libs/ apps/ 2>/dev/null | head -5)
            for f in $matches; do
              echo -e "\n### $f" >> /tmp/relevant_code.md
              head -100 "$f" >> /tmp/relevant_code.md
            done
          done
          # Cap at 30k chars
          head -c 30000 /tmp/relevant_code.md > /tmp/relevant_code_trimmed.md
          mv /tmp/relevant_code_trimmed.md /tmp/relevant_code.md

      - name: Run tests
        id: tests
        continue-on-error: true
        run: |
          source .venv/bin/activate
          python -m pytest --tb=short 2>&1 | tail -50 > /tmp/test_output.txt

      - name: Analyze with LLM
        id: analyze
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python3 << 'PYEOF'
          import json, os, urllib.request

          issue_title = os.environ.get("ISSUE_TITLE", "")
          issue_body = os.environ.get("ISSUE_BODY", "")
          labels = """${{ join(github.event.issue.labels.*.name, ', ') }}"""

          with open("/tmp/context.md") as f:
              repo_structure = f.read()
          with open("/tmp/relevant_code.md") as f:
              relevant_code = f.read()[:30000]
          with open("/tmp/test_output.txt") as f:
              test_output = f.read()

          is_bug = "bug" in labels.lower()

          prompt = f"""You are a senior software engineer triaging a GitHub issue for the NinjaStack monorepo â€” a schema-first agentic backend framework.

          ## Issue
          **Title:** {issue_title}
          **Body:** {issue_body}
          **Labels:** {labels}

          ## Repo Structure
          {repo_structure}

          ## Relevant Code
          {relevant_code}

          ## Test Results
          {test_output}

          ## Your Task
          {"This is a BUG report. Identify the likely root cause, affected files, and whether existing tests cover this area." if is_bug else "This is a FEATURE/ENHANCEMENT request. Assess feasibility, identify affected components, and flag any architectural conflicts."}

          Respond in this exact markdown format:

          ### ðŸ” Triage Analysis

          **Type:** Bug / Feature / Question / Invalid
          **Confidence:** High / Medium / Low
          **Recommendation:** `planning` or `wontfix`

          #### Summary
          (1-2 sentence summary of your findings)

          #### {"Root Cause" if is_bug else "Feasibility Assessment"}
          (detailed analysis)

          #### Affected Files
          - `path/to/file.py` â€” reason

          #### Test Coverage
          (are there existing tests? what gaps exist?)

          #### Suggested Approach
          (brief implementation direction if recommending `planning`)
          """

          body = json.dumps({
              "model": "gpt-5.2",
              "messages": [{"role": "user", "content": prompt}],
              "max_tokens": 2000,
              "temperature": 0.2
          }).encode()

          req = urllib.request.Request(
              "https://api.openai.com/v1/chat/completions",
              data=body,
              headers={
                  "Authorization": f"Bearer {os.environ['OPENAI_API_KEY']}",
                  "Content-Type": "application/json"
              }
          )
          resp = urllib.request.urlopen(req)
          result = json.loads(resp.read())
          analysis = result["choices"][0]["message"]["content"]

          with open("/tmp/analysis.md", "w") as f:
              f.write(analysis)
          PYEOF
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}

      - name: Post analysis comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('/tmp/analysis.md', 'utf8');
            const comment = `## ðŸ¤– Triage Agent\n\n${analysis}\n\n---\n_Automated analysis by NinjaStack Triage Agent. A maintainer will review and label accordingly._`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
