name: Auto-move issues to In Progress

on:
  create:

jobs:
  move-to-in-progress:
    if: github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Extract issue number from branch name
        id: extract
        run: |
          BRANCH="${{ github.event.ref }}"
          if [[ "$BRANCH" =~ (issue[-/]?)([0-9]+) ]]; then
            echo "issue_number=${BASH_REMATCH[2]}" >> "$GITHUB_OUTPUT"
            echo "Found issue #${BASH_REMATCH[2]} in branch: $BRANCH"
          else
            echo "No issue number found in branch: $BRANCH"
          fi

      - name: Move issue to In Progress on project board
        if: steps.extract.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.PROJECT_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.extract.outputs.issue_number }}"
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          PROJECT_ID="PVT_kwHNOkLOAT6Qtg"
          FIELD_ID="PVTSSF_lAHNOkLOAT6Qts4Pf31M"
          IN_PROGRESS_ID="20fd4c4d"

          # Get issue node ID
          NODE_ID=$(gh api graphql \
            -f query='query($owner:String!,$repo:String!,$num:Int!){repository(owner:$owner,name:$repo){issue(number:$num){id}}}' \
            -F owner="$OWNER" -F repo="$REPO" -F num="$ISSUE_NUM" \
            -q '.data.repository.issue.id' 2>/dev/null)

          if [ -z "$NODE_ID" ] || [ "$NODE_ID" = "null" ]; then
            echo "Issue #$ISSUE_NUM not found, skipping"
            exit 0
          fi

          # Add to project
          ITEM_ID=$(gh api graphql \
            -f query='mutation($proj:ID!,$content:ID!){addProjectV2ItemById(input:{projectId:$proj,contentId:$content}){item{id}}}' \
            -F proj="$PROJECT_ID" -F content="$NODE_ID" \
            -q '.data.addProjectV2ItemById.item.id')

          if [ -z "$ITEM_ID" ] || [ "$ITEM_ID" = "null" ]; then
            echo "Failed to add issue to project, skipping"
            exit 0
          fi

          # Move to In Progress
          gh api graphql \
            -f query='mutation($proj:ID!,$item:ID!,$field:ID!,$val:String!){updateProjectV2ItemFieldValue(input:{projectId:$proj,itemId:$item,fieldId:$field,value:{singleSelectOptionId:$val}}){projectV2Item{id}}}' \
            -F proj="$PROJECT_ID" -F item="$ITEM_ID" -F field="$FIELD_ID" -F val="$IN_PROGRESS_ID" \
            > /dev/null

          echo "âœ… Moved issue #$ISSUE_NUM to In Progress"
