name: Planning Agent

on:
  issues:
    types: [labeled]

jobs:
  plan:
    if: contains(github.event.label.name, 'planning')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Gather context
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          # Get triage comment if exists
          echo "" > /tmp/triage_comment.txt

          # Repo structure
          find libs apps -type f -name "*.py" | head -200 > /tmp/repo_files.txt

          # Relevant code
          echo "" > /tmp/relevant_code.md
          keywords=$(echo "$ISSUE_TITLE $ISSUE_BODY" | tr '[:upper:]' '[:lower:]' | grep -oE '[a-z_]{4,}' | sort -u | head -15)
          for kw in $keywords; do
            matches=$(grep -rl --include="*.py" "$kw" libs/ apps/ 2>/dev/null | head -3)
            for f in $matches; do
              echo -e "\n### $f" >> /tmp/relevant_code.md
              cat "$f" >> /tmp/relevant_code.md
            done
          done
          head -c 40000 /tmp/relevant_code.md > /tmp/relevant_code_trimmed.md
          mv /tmp/relevant_code_trimmed.md /tmp/relevant_code.md

      - name: Fetch triage analysis comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            const triageComment = comments.data.find(c => c.body.includes('ðŸ¤– Triage Agent'));
            if (triageComment) {
              fs.writeFileSync('/tmp/triage_comment.txt', triageComment.body);
            }

      - name: Generate implementation plan
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python3 << 'PYEOF'
          import json, os, urllib.request

          issue_title = os.environ.get("ISSUE_TITLE", "")
          issue_body = os.environ.get("ISSUE_BODY", "")

          with open("/tmp/repo_files.txt") as f:
              repo_structure = f.read()
          with open("/tmp/relevant_code.md") as f:
              relevant_code = f.read()[:40000]
          with open("/tmp/triage_comment.txt") as f:
              triage_analysis = f.read()

          prompt = f"""You are a principal software engineer creating an implementation plan for a GitHub issue in the NinjaStack monorepo â€” a schema-first agentic backend framework (Python, Google ADK, Pydantic, pytest).

          ## Issue
          **Title:** {issue_title}
          **Body:** {issue_body}

          ## Prior Triage Analysis
          {triage_analysis}

          ## Repo Structure
          {repo_structure}

          ## Relevant Source Code
          {relevant_code}

          ## Your Task
          Create a detailed, actionable implementation plan. Be specific about file paths, function signatures, and test cases.

          Respond in this exact markdown format:

          ### ðŸ“‹ Implementation Plan

          #### Objective
          (what this change accomplishes)

          #### Approach
          (high-level strategy â€” 2-3 sentences)

          #### Changes

          **1. `path/to/file.py`**
          - What to change and why
          - Specific functions/classes affected

          **2. `path/to/another.py`**
          - ...

          #### New Files (if any)
          - `path/to/new_file.py` â€” purpose

          #### Test Plan
          - [ ] Test case 1 â€” description
          - [ ] Test case 2 â€” description
          - Where tests should live: `libs/xxx/tests/test_xxx.py`

          #### Acceptance Criteria
          - [ ] Criterion 1
          - [ ] Criterion 2
          - [ ] All existing tests pass
          - [ ] New tests added and passing

          #### Risk Assessment
          **Risk:** Low / Medium / High
          **Breaking changes:** Yes / No
          **Migration needed:** Yes / No

          ---
          ðŸ‘ **React with ðŸ‘ to approve this plan and move to `todo`.**
          """

          body = json.dumps({
              "model": "gpt-5.2",
              "messages": [{"role": "user", "content": prompt}],
              "max_tokens": 3000,
              "temperature": 0.2
          }).encode()

          req = urllib.request.Request(
              "https://api.openai.com/v1/chat/completions",
              data=body,
              headers={
                  "Authorization": f"Bearer {os.environ['OPENAI_API_KEY']}",
                  "Content-Type": "application/json"
              }
          )
          resp = urllib.request.urlopen(req)
          result = json.loads(resp.read())
          plan = result["choices"][0]["message"]["content"]

          with open("/tmp/plan.md", "w") as f:
              f.write(plan)
          PYEOF

      - name: Post plan comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('/tmp/plan.md', 'utf8');
            const comment = `## ðŸ¤– Planning Agent\n\n${plan}\n\n---\n_React with ðŸ‘ to approve and move to \`todo\`._`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
